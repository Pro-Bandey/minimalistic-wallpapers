name: Build CDN Image Metadata

on:
  push:
    paths:
      - "images/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  metadata:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for git log history

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick
          # npm install image-size <-- Removed, not needed anymore

      - name: Generate metadata
        run: |
          node <<'EOF'
          const fs = require("fs");
          const path = require("path");
          const crypto = require("crypto");
          const { execSync } = require("child_process");

          const ROOT = "Img";
          const OUT = "images-meta.json";
          const allowed = /\.(png|jpe?g|webp|bmp|tiff|gif|svg)$/i;

          if (!fs.existsSync(ROOT)) {
            console.error(`Error: Directory "${ROOT}" not found.`);
            process.exit(1);
          }

          function walk(dir) {
            return fs.readdirSync(dir).flatMap(f => {
              const p = path.join(dir, f);
              return fs.statSync(p).isDirectory() ? walk(p) : p;
            }).filter(f => allowed.test(f));
          }

          function gitDate(file, first = false) {
            try {
              const cmd = first
                ? `git log --follow --diff-filter=A --format=%aI -- "${file}" | tail -1`
                : `git log -1 --format=%aI -- "${file}"`;
              const res = execSync(cmd).toString().trim();
              return res ? res.slice(0, 10) : new Date().toISOString().slice(0, 10);
            } catch {
              return new Date().toISOString().slice(0, 10);
            }
          }

          const files = walk(ROOT);
          const hashes = {};
          const images = [];

          for (const file of files) {
            const buf = fs.readFileSync(file);
            const hash = crypto.createHash("sha256").update(buf).digest("hex");
            
            // Width, Height, Aspect Ratio logic removed
            
            const stat = fs.statSync(file);
            const ext = path.extname(file).slice(1).toLowerCase();
            
            const relativePath = path.relative(ROOT, path.dirname(file));
            const folder = relativePath === "" ? "root" : relativePath.replace(/\\/g, "/");

            let dpi = "unknown", bit = "unknown";
            try {
              // Using ImageMagick to get deeper metadata
              const r = execSync(`identify -format "%x|%z" "${file}"`)
                .toString().trim().split("|");
              dpi = r[0] || "unknown"; 
              bit = r[1] || "unknown";
            } catch {}

            hashes[hash] = (hashes[hash] || 0) + 1;

            images.push({
              id: hash.slice(0, 12),
              name: path.basename(file),
              src: file.replace(/\\/g, "/"),
              folder,
              ext,
              // width, height, aspect_ratio removed here
              dpi,
              bit_depth: bit,
              kb: +(stat.size / 1024).toFixed(2),
              hash,
              dates: {
                added: gitDate(file, true),
                updated: gitDate(file)
              }
            });
          }

          const duplicates = Object.values(hashes).filter(v => v > 1).length;

          // --- Custom JSON Formatting Logic ---
          
          const headerData = {
            version: 1,
            generated_at: new Date().toISOString(),
            total: images.length,
            duplicates
          };

          // 1. Stringify the header normally (pretty print)
          let jsonOutput = JSON.stringify(headerData, null, 2);
          
          // 2. Remove the last closing brace '}' to append the array manually
          jsonOutput = jsonOutput.substring(0, jsonOutput.lastIndexOf("}"));

          // 3. Create the images array string where each object is 1 line
          //    We indent by 4 spaces to match the visual hierarchy
          const imageLines = images.map(img => `    ${JSON.stringify(img)}`);
          
          // 4. Join lines with commas and wrap in array brackets
          const imagesString = `,\n  "images": [\n${imageLines.join(",\n")}\n  ]\n}`;
          
          // 5. Combine header and images
          const finalContent = jsonOutput + imagesString;

          fs.writeFileSync(OUT, finalContent);
          
          console.log(`Successfully processed ${images.length} images.`);
          EOF

      - name: Deploy to Output Branch
        run: |
          cp images-meta.json /tmp/images-meta.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git fetch origin
          if git show-ref --verify --quiet refs/remotes/origin/output; then
            git checkout -f output
            git reset --hard origin/output
          else
            git checkout --orphan output
          fi
          
          git rm -rf . || true
          cp /tmp/images-meta.json images-meta.json
          
          git add images-meta.json
          git commit -m "chore: update cdn metadata [skip ci]" || echo "No changes to commit"
          git push origin output --force
